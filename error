#!/bin/bash

set -e  # Exit immediately if a command exits with a non-zero status

# Function to log messages
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# Install kubectl
install_kubectl() {
    if ! command -v kubectl &>/dev/null; then
        log "kubectl not found. Installing..."
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        log "kubectl installed successfully."
    else
        log "kubectl is already installed."
    fi

    # Verify kubectl installation
    kubectl version --client || { log "Failed to verify kubectl installation."; exit 1; }
}

# Install Helm
install_helm() {
    if ! command -v helm &>/dev/null; then
        log "Helm not found. Installing..."
        
        # Install prerequisites for Helm
        log "Installing prerequisites for Helm..."
        sudo apt-get update -y
        sudo apt-get install -y apt-transport-https

        # Install Helm
        log "Downloading and installing Helm..."
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        log "Helm installed successfully."
    else
        log "Helm is already installed."
    fi

    # Verify Helm installation
    helm version || { log "Failed to verify Helm installation."; exit 1; }
}

# Set up KUBECONFIG
setup_kubeconfig() {
    DEFAULT_KUBECONFIG="$HOME/.kube/config"
    if [ -z "$KUBECONFIG" ]; then
        if [ ! -f "$DEFAULT_KUBECONFIG" ]; then
            log "Kubeconfig not found at $DEFAULT_KUBECONFIG. Initializing Kubernetes..."
            if ! command -v minikube &>/dev/null; then
                log "Minikube not found. Installing..."
                curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
                sudo install minikube-linux-amd64 /usr/local/bin/minikube
            fi
            minikube start
        fi
        export KUBECONFIG="$DEFAULT_KUBECONFIG"
        log "KUBECONFIG set to $DEFAULT_KUBECONFIG."
    else
        log "KUBECONFIG is already set to $KUBECONFIG."
    fi
}

# Test kubectl connectivity
test_kubectl() {
    log "Testing kubectl connectivity..."
    if kubectl cluster-info &>/dev/null; then
        log "Successfully connected to the Kubernetes cluster."
    else
        log "Failed to connect to the Kubernetes cluster. Please check your configuration."
        exit 1
    fi
}

# Create namespace
setup_namespace() {
    local namespace="alloy"
    log "Creating namespace: $namespace..."
    kubectl create namespace "$namespace" || log "Namespace $namespace already exists."
}

# Add and update Helm repository
setup_helm_repo() {
    log "Adding Grafana Helm repository..."
    helm repo add grafana https://grafana.github.io/helm-charts
    helm repo update
}

# Fetch and configure values.yaml
configure_values_file() {
    local values_file="values.yaml"
    log "Fetching default values.yaml for Grafana k8s-monitoring..."
    helm show values grafana/k8s-monitoring > "$values_file"

    log "Updating custom endpoints in values.yaml..."
    sed -i "s|host:.*|host: \"http://10.0.34.144:9090\"|" "$values_file"      # Prometheus
    sed -i "s|host:.*|host: \"http://10.0.34.147:3100\"|" "$values_file"    # Loki
    sed -i "s|host:.*|host: \"http://10.0.34.193:3200\"|" "$values_file"    # Tempo (OMEGA Dev)
    sed -i "s|hostname:.*|hostname: \"omega-tempo-dev\"|" "$values_file"    # Tempo Hostname
    sed -i "/protocol:/,/^ *[^ ]/s|protocol:.*|protocol: \"remote_write\"|" "$values_file"

    log "Enabling metrics, logs, and pod logs collection in values.yaml..."
    sed -i "/metrics:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/logs:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/pod_logs:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"

    log "Enabling additional components: Cost, Kepler, etc..."
    sed -i "/Cost:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/Kepler:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/node-exporter:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/cluster_events:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/Opencost:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/kube-state-metrics:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/prometheus-node-exporter:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"
    sed -i "/prometheus-operator-crds:/,/^ *[^ ]/s|enabled:.*|enabled: true|" "$values_file"

    log "values.yaml updated successfully."
}

# Deploy monitoring stack
deploy_monitoring_stack() {
    local namespace="alloy"
    local values_file="values.yaml"

    log "Deploying Grafana k8s-monitoring stack to namespace $namespace..."
    helm install -n "$namespace" grafana-k8s-monitoring grafana/k8s-monitoring -f "$values_file"
}

# Verify deployment
verify_deployment() {
    local namespace="alloy"
    log "Verifying deployment in namespace $namespace..."
    kubectl get pods -n "$namespace"
    log "Note: The OpenCost pod may not run initially as it requires additional configuration. Please configure OpenCost separately for cost management."
}

# Main function
main() {
    install_kubectl
    install_helm
    setup_kubeconfig
    test_kubectl
    setup_namespace
    setup_helm_repo
    configure_values_file
    deploy_monitoring_stack
    verify_deployment
    log "Grafana monitoring stack setup completed successfully."
}

# Run the script
main
