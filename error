#!/bin/bash

# Configuration Variables
OMEGA="omega"
PROMETHEUS_IP="http://10.0.34.144:9090"  # Correct Prometheus IP
LOKI_HOST="http://10.0.34.147:3100"
TEMPO_HOST="http://10.0.34.193:3200"
VALUES="values.yml"
NAMESPACE="alloy"

# Step 1: Install kubectl
echo "Downloading the latest stable release of kubectl..."
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
echo "kubectl downloaded and made executable."

echo "Moving kubectl to /usr/local/bin..."
sudo mv kubectl /usr/local/bin/

# Step 2: Install Helm
echo "Installing prerequisites for Helm (if not already installed)..."
sudo apt-get install apt-transport-https -y

echo "Installing Helm (Helm 3)..."
curl -s https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz | tar xz
sudo mv linux-amd64/helm /usr/local/bin/helm
echo "Helm installation completed."

# Step 3: Create Kubernetes Namespace for Alloy
echo "Creating Kubernetes namespace 'alloy'..."
kubectl create namespace $NAMESPACE || echo "Namespace $NAMESPACE already exists."

# Step 4: Add the Grafana Helm Chart Repository
echo "Adding Grafana Helm chart repository..."
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

# Step 5: Create a Kubernetes Secret for Prometheus Authentication
echo "Creating Kubernetes Secret for Prometheus authentication..."
kubectl create secret generic prometheus-k8s-monitoring \
--from-literal=username='admin' \
--from-literal=password='admin' \
-n $NAMESPACE

# Step 6: Modify the values.yaml file
echo "Scraping default values.yml file from Grafana Helm chart..."
helm show values grafana/k8s-monitoring > $VALUES

echo "Modifying values.yml with custom configurations..."
# Update cluster name
sed -i "/cluster:/,/^ *name:/s/name: \"\"/name: \"$OMEGA\"/" "$VALUES"
PROMETHEUS_IP=$(echo "$PROMETHEUS_IP" | sed 's/\//\\\//g')
sed -i "/prometheus:/,/^ *host:/s/host: \"\"/host: \"$PROMETHEUS_IP\"/" "$VALUES"

# Update Loki and Tempo endpoints
sed -i -e "/^\s*loki:/,/^\s*host:/ s|^\(\s*host:\).*|\1 \"$LOKI_HOST\"|" "$VALUES"
sed -i -e "/^\s*tempo:/,/^\s*host:/ s|^\(\s*host:\).*|\1 \"$TEMPO_HOST\"|" "$VALUES"

# Enable necessary features
sed -i "/traces:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/kepler:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/cost:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/node-exporter:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/cluster_events:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/opencost:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/kube-state-metrics:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/prometheus-node-exporter:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"
sed -i "/prometheus-operator-crds:/,/^ *enabled: false/s/false/$TRUE/" "$VALUES"

# Set Prometheus authentication credentials for OpenCost
echo "Setting Prometheus authentication credentials for OpenCost..."
cat <<EOF >> $VALUES
opencost:
  enabled: true
  prometheus:
    url: $PROMETHEUS_IP
    username: admin
    password: admin
EOF

echo "Finished modifying values.yml."

# Step 7: Install Grafana Alloy Monitoring Stack using Helm
echo "Installing Grafana Alloy stack in the 'alloy' namespace..."
helm install -n $NAMESPACE grafana-k8s-monitoring grafana/k8s-monitoring -f $VALUES

# Step 8: Verify Pods are Running
echo "Verifying that all necessary pods are running..."
kubectl get pods -n $NAMESPACE

# Step 9: Set Up Grafana Dashboards
echo "Set up Grafana dashboards..."
echo "To visualize the data in Grafana, navigate to http://<grafana-server-ip>:3000"
echo "Login with the admin credentials and import pre-built Kubernetes dashboards."
echo "Ensure data sources are configured correctly for Prometheus, Loki, and Tempo."

# End of Script
echo "Rancher Kubernetes Monitoring setup with Grafana Alloy completed."
