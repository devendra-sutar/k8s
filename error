#!/bin/bash

set -e  # Exit immediately if a command exits with a non-zero status

# Function to log messages
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# Install kubectl
install_kubectl() {
    if ! command -v kubectl &>/dev/null; then
        log "kubectl not found. Installing..."
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        log "kubectl installed successfully."
    else
        log "kubectl is already installed."
    fi
}

# Install Helm
install_helm() {
    if ! command -v helm &>/dev/null; then
        log "Helm not found. Installing..."
        sudo apt-get update -y
        sudo apt-get install -y apt-transport-https
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        log "Helm installed successfully."
    else
        log "Helm is already installed."
    fi
}

# Create namespace for monitoring stack
create_namespace() {
    kubectl create namespace alloy || log "Namespace alloy already exists."
}

# Add Helm repo and update
add_helm_repo() {
    helm repo add grafana https://grafana.github.io/helm-charts
    helm repo update
}

# Fetch and modify values.yaml
configure_values_file() {
    helm show values grafana/k8s-monitoring > values.yaml

    # Modify values.yaml for custom endpoints and settings
   echo "Updating values.yaml with custom endpoints and configurations..."

# Update Prometheus host
sed -i 's|^\s*prometheus.host:\s*.*|prometheus.host: "http://10.0.34.144:9090"|' values.yaml  # Prometheus

# Update Loki host
sed -i 's|^\s*loki.host:\s*.*|loki.host: "http://10.0.34.147:3100"|' values.yaml  # Loki

# Update Tempo host
sed -i 's|^\s*tempo.host:\s*.*|tempo.host: "http://10.0.34.193:3200"|' values.yaml  # Tempo

# Update protocol to "remote_write"
sed -i '/protocol:/,/^ *[^ ]/s|protocol:.*|protocol: "remote_write"|' values.yaml  # Protocol



    # Enable required components
    sed -i "/metrics:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/logs:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/pod_logs:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/Cost:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/Kepler:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/node-exporter:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/cluster_events:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/Opencost:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/kube-state-metrics:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/prometheus-node-exporter:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml
    sed -i "/prometheus-operator-crds:/,/^ *[^ ]/s|enabled:.*|enabled: true|" values.yaml

    log "values.yaml updated successfully."
}

# Deploy Grafana Alloy monitoring stack
deploy_stack() {
    helm install -n alloy grafana-k8s-monitoring grafana/k8s-monitoring -f values.yaml
}

# Verify deployment
verify_deployment() {
    kubectl get pods -n alloy
}

# Main function to execute steps
main() {
    log "Starting Grafana Alloy monitoring setup..."
    install_kubectl
    install_helm
    create_namespace
    add_helm_repo
    configure_values_file
    deploy_stack
    verify_deployment
    log "Grafana Alloy monitoring stack deployment completed."
}

# Run the main function
main
